# Les protocoles SNMP et NRPE

## üì° SNMP (Simple Network Management Protocol)

### ‚úÖ D√©finition :

Protocole standard de gestion de r√©seau, utilis√© pour superviser les √©quipements (switchs, routeurs, imprimantes, etc.).
#### ‚öôÔ∏è El√©ments de fonctionnement
**Agent SNMP** sur l'√©quipement ‚Üí r√©pond aux requ√™tes SNMP sur le port 161 (TPC/UDP)  
**Superviseur (Centreon/Nagios)** ‚Üê re√ßoit les traps (alertes) sur le port 162  
**MIB (Management Information Base)** : base de donn√©es hi√©rarchique d‚Äôobjets (OID) dont disposent les agents et que le superviseur interrogera via SNMP pour obtenir des informations.    
**OID (Object Identifier)** : identifiant unique pour chaque variable √† surveiller. Il est d√©finit par une suite de chiffre et de point. (Exemple : 1.3.6.1.2.1.2.2.1.2 = Ifdescr = description d'une interface r√©seau)

- Versions :
    - v1 : (obsol√®te)
    - v2c : simple avec cha√Æne de communaut√© (**mot de passe** utilis√© pour acc√©der aux informations d‚Äôun √©quipement r√©seau), la plus utilis√©, peu s√©curis√©
    - v3 : plus s√©curis√© (authentification), mais peu impl√©ment√©e
##### Quelques Exemple OID 

|üîé Objectif|üÜî OID|
|---|---|
|Nom de l‚Äôinterface|`.1.3.6.1.2.1.2.2.1.2.X`|
|Statut administratif (enable/disable)|`.1.3.6.1.2.1.2.2.1.7.X`|
|Statut op√©rationnel (up/down)|`.1.3.6.1.2.1.2.2.1.8.X`|
|Octets re√ßus sur une interface|`.1.3.6.1.2.1.2.2.1.10.X`|
|Octets envoy√©s sur une interface|`.1.3.6.1.2.1.2.2.1.16.X`|
Les **OID** d√©pendent des **MIB** de chaque constructeur. Les OID sont hi√©rarchiquement organis√©s et normalis√©s par l‚Äô**IETF**.

### üñ•Ô∏è Installation du service SNMP
<!-- tabs:start -->
#### **Windows**
`Add-WindowsCapability -Online -Name ‚ÄúSNMP.Client~~~~0.0.1.0‚Äú`  
Configuration via services.msc / Service SNMP dans l'onglet s√©curit√©   
Redemarrer le service   

#### **Linux (Debian)**

- Installer `snmpd`  
- Configurer `/etc/snmp/snmpd.conf` :
	- Faire un backup du snmpd.conf d'origine
	- Editer le fichier snmpd.conf 
- Red√©marrer

Deux outils : 
- `snmpwalk` : liste des objets SNMP
- `snmpget` : r√©cup√©ration cibl√©e d‚Äôun objet

Exemple snmpwalk : 
```bash
snmpwalk -v2c -Of -c public localhost
# v2c = Version du protocol
# -c public = Communaut√© public
# -Of = Afficher les noms / -On = R√©cup√©rer les informations de num√©ro
```

Exemple de configuration du fichier snmpd.conf

```bash
######################################################
# CONFIGURATION SNMP POUR SUPERVISION CENTREON
######################################################

# Active l'√©coute SNMP sur toutes les interfaces, port UDP 161
agentAddress udp:161

# D√©finition de la communaut√© SNMPv2c "sniper" autoris√©e uniquement depuis 172.16.1.10
com2sec centreon-sniper 172.16.1.10 sniper

# D√©finition d'un groupe SNMPv2c "mygroup" li√© √† la communaut√© centreon-sniper
group mygroup v2c centreon-sniper

######################################################
# OUVERTURE DES OID POUR LA VUE TP1
######################################################

# D√©finition de la vue "TP1" permettant l'acc√®s √† certains OID
view TP1 included .1.3.6.1.4.1.2021.4        
view TP1 included .1.3.6.1.4.1.2021.10     
view TP1 included .1.3.6.1.2.1.25.3       
view TP1 included .1.3.6.1.2.1.25.2.1   
view TP1 included .1.3.6.1.2.1.25.2.3 

# Attention, ne pas mettre de commentaire sur la ligne view

######################################################
# DROITS D‚ÄôACC√àS AUX VUES SNMP
######################################################

# Autorise le groupe "mygroup" √† acc√©der √† la vue "TP1" en lecture seule, sans authentification
access mygroup "" any noauth exact TP1 none none

```
<!-- tabs:end -->

Test de fonctionnement **depuis le centreon** avec ``snmpwalk -v2c -c sniper 172.16.1.101 .1.3.6.1.4.1.2021.4``



## üß™ NRPE (Nagios Remote Plugin Executor)

### ‚úÖ D√©finition :
Protocole con√ßu pour ex√©cuter √† distance des scripts/plugins sur un h√¥te distant.

### ‚öôÔ∏è Fonctionnement :
- Le superviseur ex√©cute des **sondes NRPE** via le port **5666**
- Un **agent NRPE (ex : NSClient++)** sur l‚Äôh√¥te ex√©cute localement les plugins
- Utilis√© pour **Windows/Linux** afin de superviser CPU, RAM, espace disque‚Ä¶
	- Tr√®s utilis√© sur windows car chiffr√© via SSL/TLS
### üîê Avantage :
- **Chiffrement via SSL/TLS** (contrairement √† SNMP v1/v2c)
- Permet d‚Äôinterroger des informations d√©taill√©es indisponibles via SNMP

### üõ†Ô∏è Installation :
- Logiciel recommand√© : **NSClient++**  
    ‚Üí [https://www.nsclient.org](https://www.nsclient.org)  
    (disponible pour Windows et Linux)

- Lors de l'installation : 
	- Indiquer le/les IP pouvant faire des requet√©s NRPE
	- Enable Check Plugin
	- Enable NRPE server - Insecure
	- Enable Web Server
	- Configuration via localhost:8443
		- Charger le ``module checkdisk`` (cliquer sur ``Module is not enabled``)
		- Valider avec ``changes/save`` - La prise en compte peut prendre quelques secondes
	- Requ√™tes dans la partie ``Queries``

üîß **Modules fr√©quemment utilis√©s avec NRPE / NSClient++**

| Module              | Description                                                             |
| ------------------- | ----------------------------------------------------------------------- |
| `CheckSystem`       | V√©rifie l'√©tat syst√®me : CPU, RAM, uptime, etc.                         |
| `CheckDisk`         | V√©rifie l‚Äôespace disque (disques logiques, montages, etc.).             |
| `CheckEventLog`     | Supervise les √©v√©nements Windows (erreurs, warnings, logs sp√©cifiques). |
| `CheckServiceState` | V√©rifie si un service Windows est d√©marr√© ou arr√™t√©.                    |
| `CheckFile`         | Contr√¥le l‚Äôexistence ou la taille de fichiers (logs, batchs, etc.).     |
| `CheckCounter`      | Lit des compteurs de performance Windows (CPU usage, I/O, etc.).        |
| `NRPE Server`       | Permet de recevoir des requ√™tes NRPE depuis le serveur de supervision.  |
| `NSCA Agent`        | Pour envoyer des alertes vers le serveur Nagios via NSCA (push).        |
| `Scheduler`         | Planifie des t√¢ches de supervision locales.                             |

Contr√¥le de fonctionnement **depuis le centr√©on** : 
``./usr/lib/nagios/plugins/check_centreon_nrpe3 -H 172.16.1.100``


## üîÑ Comparatif SNMP vs NRPE

| Crit√®re        | SNMP                                | NRPE                    |
| -------------- | ----------------------------------- | ----------------------- |
| S√©curit√©       | Faible (sauf v3)                    | SSL possible            |
| Mise en ≈ìuvre  | Simple                              | Plus technique          |
| OS support√©s   | Tout (y compris √©quipements r√©seau) | Principalement serveurs |
| Fonctionnement | Pull + trap (event)                 | Commande √† distance     |
- SNMP est¬†**universel**, NRPE est plus¬†**adapt√© aux serveurs**¬†et contextes sensibles
- SNMPv2c doit √™tre s√©curis√© (filtrage IP, communaut√© forte)
- NRPE permet une supervision¬†**granulaire**, mais n√©cessite plus d‚Äôinstallation c√¥t√© client
- Il est recommand√© d‚Äô**utiliser SNMP et NRPE en compl√©ment**
