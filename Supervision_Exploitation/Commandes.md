# Les commandes de supervision

## âš™ï¸ RÃ´le des commandes dans la supervision

Le moteur Centreon exÃ©cute Ã  intervalles rÃ©guliers (par dÃ©faut toutes les 5 minutes) des **commandes de supervision** appelÃ©es aussi **_checks_**. Ces commandes permettent de vÃ©rifier lâ€™Ã©tat :
- des **hÃ´tes** (machines, serveursâ€¦)
- et des **services** (CPU, mÃ©moire, trafic rÃ©seauâ€¦)

Chaque vÃ©rification repose sur lâ€™exÃ©cution dâ€™un **script ou binaire** issu :
- soit des **Nagios Plugins** (historiques, dans `/usr/lib64/nagios/plugins`)
- soit des **Centreon Plugins** (modernes, dans `/usr/lib/centreon/plugins`

## Fonctionnement du Check

1. Le moteur **Centreon-Engine** lance une commande via le service associÃ© Ã  l'hÃ´te Ã  superviser.
2. Il exÃ©cute la commande dÃ©finie (script)
3. La commande interroge le service
4. La commande retourne : 
	- Un message texte pour affichage
	- unÂ **code**Â (statut) 
	- donnÃ©es (texte ou mÃ©triques)
5. Le moteur analyse le code retour et applique des actions si nÃ©cessaire

### ğŸš¦ Codes de statut

<!-- tabs:start -->
#### **ğŸ–¥ï¸Statuts pour les hÃ´tes**

| Statut      | Code | Signification                                |
| ----------- | ---- | -------------------------------------------- |
| UP          | 0    | HÃ´te joignable                               |
| DOWN        | 1    | Machine non atteignable (Ã©teinte)            |
| UNREACHABLE | 2    | Machine parente DOWN ou machine inaccessible |

#### **ğŸ”§Statuts pour les services**

| Statut   | Code | Signification                            |
| -------- | ---- | ---------------------------------------- |
| OK       | 0    | Tout est fonctionnel                     |
| WARNING  | 1    | Attention, seuil dâ€™alerte atteint        |
| CRITICAL | 2    | ProblÃ¨me important dÃ©tectÃ©               |
| UNKNOWN  | 3    | DonnÃ©es absentes ou erreur de la sonde   |
| PENDING  | 4    | DonnÃ©es en attente dâ€™analyse statistique |
<!-- tabs:end -->

## âœï¸ Ã‰crire et utiliser des sondes

<!-- tabs:start -->
### **Sondes Nagios**
- SituÃ©es dans : `/usr/lib64/nagios/plugins`
- Option `-h` : aide
- Options courantes : `-w` (seuil warning) et `-c` (seuil critical)
- Exemple : `check_ping -H 8.8.8.8 -w 100,20% -c 200,40%`

**Demonstration**
Se connecter avec l'utilisateur centreon-engine : ``su - centreon-engine``  
Se rendre dans `/usr/lib64/nagios/plugins`  
``./check_ping -H 172.102.1.1 -w 1,50% -c 2,80% -p 3``  
	-H pour prÃ©ciser l'hote  
	 -w pour le seuil warning (1s ou 50%)  
	 -c pour le seuil critique  
	 -p pour le nombre de paquet  
	``./check_ping -h`` pour l'aide du check    
Le code d'erreur sera affichÃ© avec la commande ``echo $?``
### **Plugins SNMP (Centreon)**
- RÃ©pertoire : `/usr/lib/centreon/plugins`
- OrganisÃ©s par domaine (Windows, Linux, RÃ©seauxâ€¦)

**Demonstration**  
Se connecter avec l'utilisateur centreon-engine : ``su - centreon-engine``      
Se rendre dans `/usr/lib/centreon/plugins`    
``./centreon_windows_snmp.pl --list-plugin`` - Affiche le nom exacte du plugin  
``./centreon_windows_snmp.pl --plugin=os::windows::snmp::plugin --help`` - Affiche l'aide du plugin sÃ©lectionnÃ©  
``./centreon_windows_snmp.pl --plugin=os::windows::snmp::plugin --list-mode`` - Pour voir les modes  
On continue Ã  dÃ©roule les OID. jusqu'Ã  avoir la commande dÃ©finitive 

### **Sonde NRPE**
- Plugin pour exÃ©cuter des commandes Ã  distance
- Fichier : `check_centreon_nrpe3`
- RÃ©pertoire : `/usr/lib/nagios/plugins`
- Version indiquÃ©e par le chiffre (`nrpe3` = v3)

**Demonstration**  

**Sur le client NSClient++ windows**
Dans Queries; en allant dans RUN, nous pouvons activer des filtres : 
``check_cpu "warn=load > 75" "critical=load > 85"``

**Depuis le serveur de supervision**
Activer l'option sur le client : ``Setting / NRPE / server / Allowarguments true et allow nasty caracters true`` puis sauvegarder

Se rendre dans `/usr/lib/nagios/plugins`
``./check_centreon_nrpe3 -H 172.6.102.101 -c check_cpu -a "warn=load > 50"  
echo $?``


<!-- tabs:end -->