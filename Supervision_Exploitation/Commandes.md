# Les commandes de supervision

## ⚙️ Rôle des commandes dans la supervision

Le moteur Centreon exécute à intervalles réguliers (par défaut toutes les 5 minutes) des **commandes de supervision** appelées aussi **_checks_**. Ces commandes permettent de vérifier l’état :
- des **hôtes** (machines, serveurs…)
- et des **services** (CPU, mémoire, trafic réseau…)

Chaque vérification repose sur l’exécution d’un **script ou binaire** issu :
- soit des **Nagios Plugins** (historiques, dans `/usr/lib64/nagios/plugins`)
- soit des **Centreon Plugins** (modernes, dans `/usr/lib/centreon/plugins`

## Fonctionnement du Check

1. Le moteur **Centreon-Engine** lance une commande via le service associé à l'hôte à superviser.
2. Il exécute la commande définie (script)
3. La commande interroge le service
4. La commande retourne : 
	- Un message texte pour affichage
	- un **code** (statut) 
	- données (texte ou métriques)
5. Le moteur analyse le code retour et applique des actions si nécessaire

### 🚦 Codes de statut

<!-- tabs:start -->
#### **🖥️Statuts pour les hôtes**

| Statut      | Code | Signification                                |
| ----------- | ---- | -------------------------------------------- |
| UP          | 0    | Hôte joignable                               |
| DOWN        | 1    | Machine non atteignable (éteinte)            |
| UNREACHABLE | 2    | Machine parente DOWN ou machine inaccessible |

#### **🔧Statuts pour les services**

| Statut   | Code | Signification                            |
| -------- | ---- | ---------------------------------------- |
| OK       | 0    | Tout est fonctionnel                     |
| WARNING  | 1    | Attention, seuil d’alerte atteint        |
| CRITICAL | 2    | Problème important détecté               |
| UNKNOWN  | 3    | Données absentes ou erreur de la sonde   |
| PENDING  | 4    | Données en attente d’analyse statistique |
<!-- tabs:end -->

## ✍️ Écrire et utiliser des sondes

<!-- tabs:start -->
### **Sondes Nagios**
- Situées dans : `/usr/lib64/nagios/plugins`
- Option `-h` : aide
- Options courantes : `-w` (seuil warning) et `-c` (seuil critical)
- Exemple : `check_ping -H 8.8.8.8 -w 100,20% -c 200,40%`

**Demonstration**
Se connecter avec l'utilisateur centreon-engine : ``su - centreon-engine``  
Se rendre dans `/usr/lib64/nagios/plugins`  
``./check_ping -H 172.102.1.1 -w 1,50% -c 2,80% -p 3``  
	-H pour préciser l'hote  
	 -w pour le seuil warning (1s ou 50%)  
	 -c pour le seuil critique  
	 -p pour le nombre de paquet  
	``./check_ping -h`` pour l'aide du check    
Le code d'erreur sera affiché avec la commande ``echo $?``
### **Plugins SNMP (Centreon)**
- Répertoire : `/usr/lib/centreon/plugins`
- Organisés par domaine (Windows, Linux, Réseaux…)

**Demonstration**  
Se connecter avec l'utilisateur centreon-engine : ``su - centreon-engine``      
Se rendre dans `/usr/lib/centreon/plugins`    
``./centreon_windows_snmp.pl --list-plugin`` - Affiche le nom exacte du plugin  
``./centreon_windows_snmp.pl --plugin=os::windows::snmp::plugin --help`` - Affiche l'aide du plugin sélectionné  
``./centreon_windows_snmp.pl --plugin=os::windows::snmp::plugin --list-mode`` - Pour voir les modes  
On continue à déroule les OID. jusqu'à avoir la commande définitive 

### **Sonde NRPE**
- Plugin pour exécuter des commandes à distance
- Fichier : `check_centreon_nrpe3`
- Répertoire : `/usr/lib/nagios/plugins`
- Version indiquée par le chiffre (`nrpe3` = v3)

**Demonstration**  

**Sur le client NSClient++ windows**
Dans Queries; en allant dans RUN, nous pouvons activer des filtres : 
``check_cpu "warn=load > 75" "critical=load > 85"``

**Depuis le serveur de supervision**
Activer l'option sur le client : ``Setting / NRPE / server / Allowarguments true et allow nasty caracters true`` puis sauvegarder

Se rendre dans `/usr/lib/nagios/plugins`
``./check_centreon_nrpe3 -H 172.6.102.101 -c check_cpu -a "warn=load > 50"  
echo $?``


<!-- tabs:end -->