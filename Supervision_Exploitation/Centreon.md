# Supervision avec Centreon

Centreon est un **outil de supervision**. Il permet de surveiller l'Ã©tat dâ€™un parc informatique : serveurs, switchs, imprimantes, services (CPU, HTTP, disqueâ€¦), etc.

Il repose sur **des plugins externes** pour faire les vÃ©rifications. Il nâ€™interroge pas directement les machines, mais dÃ©lÃ¨gue Ã§a Ã  des sondes.

## ğŸ“š Historique et Ã©volution

Les dÃ©buts :
- ğŸ•°ï¸ **1999** : naissance de **NetSaint**, renommÃ© ensuite **Nagios**, ordonnanceur de tÃ¢ches avec alertes et reporting.
- ğŸ‡«ğŸ‡· **2003** : lancement du projet **Oreon**, surcouche graphique Ã  Nagios, facilitant la visualisation et la configuration.
- ğŸ¢ **2005** : crÃ©ation de la sociÃ©tÃ© **Merethis** pour encadrer le dÃ©veloppement.
- ğŸ§­ **2007** : Oreon devient **Centreon**.
- ğŸ§© **2009** : Centreon devient une solution autonome avec : 
	- Modules complÃ©mentaires : **Centreon Map**, **MBI**, automatisation... 
	- Interface Web complÃ¨te, plus quâ€™une simple surcouche.
- âš™ï¸2011/2012 : 
	- CrÃ©ation de **Centreon-Engine** (remplace Nagios)
	- CrÃ©ation de **Centreon-Broker** (remplace NDOUtils)
- ğŸ§­ 2018 : nouvelle logique de versioning â†’Â _annÃ©e.mois_Â (ex : 18.10)

## ğŸ§± Architecture et Installation

Centreon est composÃ© de plusieurs briques :

|Composant|RÃ´le|
|---|---|
|**Centreon Web**|Interface graphique (Web) pour configurer et surveiller|
|**Centreon Engine**|Le moteur qui exÃ©cute les vÃ©rifications|
|**Centreon Broker**|GÃ¨re les flux de donnÃ©es entre Engine, DB et Web|
|**Base de donnÃ©es**|Stocke les rÃ©sultats, historiques, config, logs|
|**Plugins / sondes**|Les scripts qui font les vÃ©rifications (check_ping, etc.)|

ğŸ’¡ Centreon **nâ€™intÃ¨gre aucun mÃ©canisme de supervision en interne**. Les vÃ©rifications sâ€™effectuent exclusivement via les **plugins**, qui sont des scripts exÃ©cutÃ©s par lâ€™engine.

### ğŸ’½ MÃ©thodes dâ€™installation

Tu peux installer Centreon de plusieurs maniÃ¨res :
- ğŸ“€ Via **lâ€™ISO officielle** (simple et rapide)
- ğŸ“¦ Via **paquets RPM** (CentOS, Rocky Linux, Oracle Linux)
- ğŸ–¥ï¸ Via **machine virtuelle**
- âš™ï¸ Via **compilation des sources**

ğŸ”— Ressources utiles :
- [ğŸ“˜ Documentation officielle](https://docs.centreon.com/current/fr/installation/introduction.html)

## ğŸ› ï¸ Configuration de Centreons

### Bonnes pratiques
- Rendre les **commandes les plus gÃ©nÃ©riques et structurÃ©es possibles** : utiliser des **paramÃ¨tres variables** pour Ã©viter les commandes figÃ©es : ``CHECK_SNMP_CPU``, ``CHECK_NRPE_DISK``..
- Toujours utiliserÂ **des arguments variables**Â avec macros ($ARGn$, $_HOSTâ€¦$)
- Tester chaque commande enÂ **ligne de commande avec centreon-engine**Â avant de lâ€™ajouter dans lâ€™interface

### Macros dans Centreon
Les **macros** permettent de rendre les commandes dynamiques. Elles sont remplacÃ©es au moment de lâ€™exÃ©cution rÃ©elle.  

**Types principaux** :

|Type|Exemple / Usage|
|---|---|
|**Standards**|`$HOSTADDRESS$` : adresse IP de lâ€™hÃ´te|
|**Ressources**|`$USER1$`, `$CENTREONPLUGINS$` : chemins vers les plugins|
|**Ã€ la demande**|`$HOSTSTATE:nomHÃ´te$` : Ã©tat dynamique dâ€™un autre objet|
|**Arguments**|`$ARG1$`, `$ARG2$` : seuils, valeurs variables (max 32)|
|**PersonnalisÃ©es**|`$_HOSTSNMPVERSION$`, `$_SERVICEWARNING$` : plus claires, sans limite fixÃ©e|

>ğŸ’¡ Les macros personnalisÃ©es sont **recommandÃ©es** : plus lisibles et adaptables.
> Les macros se retrouvent dans Configuration / Pollers / Resources 


### Ã‰criture des commandes

- Toujours **tester les commandes en shell** avec lâ€™utilisateur `centreon-engine` avant de les intÃ©grer Ã  lâ€™interface.
- Menu : `Configuration â†’ Commands â†’ Checks`
- Exemple : `check_snmp_cpu_windows --warning=$ARG1$ --critical=$ARG2$`

#### Exemple SNMP CPU

```bash
/usr/lib/centreon/plugins/centreon_windows_snmp.pl
--plugin=os::windows::snmp::plugin
--mode=cpu
--hostname=$HOSTADDRESS$ # Macro standard
--snmp-community=$_HOSTSNMPCOMMUNITY$ # Macro personnalisÃ©e 
--snmp-version=$_HOSTSNMPVERSION$
--warning-average=$ARG1$ # Macro Argument
--critical-average=$ARG2$
```


### Checks (sondes) - Commandes

Menu :Â **Configuration > Commands > Checks**

Champs Ã  renseigner :

- Nom (ex:Â `CHECK_SNMP_CPU`)
- Ligne de commande avec variables ($ARGn$, $_HOSTâ€¦$)
- Type de commande :Â `Check`Â ouÂ `Misc`
- Plugin utilisÃ© : chemin via macroÂ `$CENTREONPLUGINS$`,Â `$USER1$`

### ğŸ§± Les modÃ¨les
<!-- tabs:start -->
#### **ModÃ¨le de service**

Un **service** = un indicateur quâ€™on veut surveiller sur lâ€™hÃ´te (CPU, mÃ©moire, HTTPâ€¦)

ğŸ”¹ **ModÃ¨le de service** = modÃ¨le rÃ©utilisable qui dÃ©finit :
- La commande de supervision (check)
- Les seuils warning/critical
- Les pÃ©riodes
- Les macros utilisÃ©es

ğŸ“¦ Deux types :
- **STC_** : modÃ¨le de configuration (`STC_DEFAULT`) â†’ Check Period, Retryâ€¦
- **STF_** : modÃ¨le fonctionnel (`STF_SNMP_CPU`) â†’ contient la commande Ã  exÃ©cuter
- **Commande de check** : lien vers la commande de supervision (ex : `check_snmp_cpu`)

#####  Gestion des statuts : SOFT vs HARD

Centreon distingue deux Ã©tats lorsquâ€™un service rencontre un problÃ¨me :
- **SOFT** : erreur dÃ©tectÃ©e mais non confirmÃ©e
    - Le moteur retente la vÃ©rification (`Retry Interval`) selon `Max Check Attempts`
    - Aucun message de notification nâ€™est envoyÃ© Ã  ce stade
        
- **HARD** : erreur confirmÃ©e
    - La notification est envoyÃ©e
    - Le service entre en alerte (WARNING, CRITICAL...)
        

ğŸŸ¢ Un Ã©tat OK est **automatiquement confirmÃ©**.

> Exemple :
> - Normal Check Interval = 5 min
> - Max Check Attempts = 3
> - Retry Check Interval = 1 min  
>     RÃ©sultat : aprÃ¨s 3 Ã©checs Ã  1 min dâ€™intervalle â†’ le statut passe en HARD

##### RÃ¨gles de nommage (recommandÃ©es)

Adopter une convention de nommage stricte :
- `STC_` pour _Service Template Configuration_
- `STF_` pour _Service Template Functional_
- `CHECK_` dans le nom de la commande liÃ©e

Cela facilite lâ€™organisation, la recherche et la maintenance.

**CrÃ©ation**
Configuration / Service / Service Template dans Centreon
#### **ModÃ¨les d'hÃ´te**

Un **hÃ´te** = une machine Ã  superviser (par son IP ou nom DNS)

ğŸ”¹ **ModÃ¨le dâ€™hÃ´te (HTC/HTF)** = fiche de paramÃ¨tres par dÃ©faut pour tous les hÃ´tes de ce type  
Il peut contenir :
- La commande de vÃ©rification (pingâ€¦)
- Les paramÃ¨tres SNMP
- Les intervalles
- Des modÃ¨les de services Ã  dÃ©ployer automatiquement

ğŸ“¦ Deux types :
- **HTC_** : configuration gÃ©nÃ©rique (`HTC_DEFAULT`)
- **HTF_** : selon rÃ´le/fonction/OS (`HTF_LINUX_SRVWEB`, `HTF_WIN_DC`, etc.)

#### **Articulation**

```markdown
             Centreon Engine
                  â†“
             [HÃ”TE : serveur X]
                  â†‘
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   ModÃ¨le dâ€™hÃ´te HTF_WIN  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
   Applique les modÃ¨les de services :
     â†’ STF_CPU_WIN
     â†’ STF_RAM_WIN
     â†’ STF_DISK_WIN

Chaque modÃ¨le de service :
- contient la commande CHECK_SNMP_CPU
- contient des macros ($_HOSTSNMPVERSION$, $_SERVICEWARNING$)

```

> ğŸ” Tu crÃ©es donc un **modÃ¨le dâ€™hÃ´te**, tu y lies des **modÃ¨les de services**, et tu nâ€™as plus quâ€™Ã  **dÃ©ployer un nouvel hÃ´te** â†’ tout sâ€™applique automatiquement.

<!-- tabs:end -->
### ğŸ” Application de la configuration

âš ï¸ Les modifications dans lâ€™interface ne sont **pas appliquÃ©es directement**.

Ã‰tapes :
1. GÃ©nÃ©ration des fichiers de config (`/usr/share/centreon/filesGeneration`) - Configuration / pollers / Export configuration
2. VÃ©rification (mode debug recommandÃ©)
3. Remplacement des anciens fichiers (`/etc/centreon/*.cfg`)
4. **Reload** du moteur Centreon

Ce mÃ©canisme permet dâ€™Ã©viter de recharger une configuration invalide.

### ğŸ‘ï¸ Interface de supervision

- Menu de supervision :
    - `Monitoring â†’ Status Details â†’ Services`
    - `Monitoring â†’ Status Details â†’ Hosts`

- Affichage par hÃ´te ou service avec actions groupÃ©es disponibles
- PossibilitÃ© de consulter les **dÃ©tails**, logs et raccourcis vers la config

## [SynthÃ¨se](/Supervision_Exploitation/Synthese_centreon.md)



