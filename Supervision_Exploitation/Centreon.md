# Supervision avec Centreon

Centreon est un **outil de supervision**. Il permet de surveiller l'état d’un parc informatique : serveurs, switchs, imprimantes, services (CPU, HTTP, disque…), etc.

Il repose sur **des plugins externes** pour faire les vérifications. Il n’interroge pas directement les machines, mais délègue ça à des sondes.

## 📚 Historique et évolution

Les débuts :
- 🕰️ **1999** : naissance de **NetSaint**, renommé ensuite **Nagios**, ordonnanceur de tâches avec alertes et reporting.
- 🇫🇷 **2003** : lancement du projet **Oreon**, surcouche graphique à Nagios, facilitant la visualisation et la configuration.
- 🏢 **2005** : création de la société **Merethis** pour encadrer le développement.
- 🧭 **2007** : Oreon devient **Centreon**.
- 🧩 **2009** : Centreon devient une solution autonome avec : 
	- Modules complémentaires : **Centreon Map**, **MBI**, automatisation... 
	- Interface Web complète, plus qu’une simple surcouche.
- ⚙️2011/2012 : 
	- Création de **Centreon-Engine** (remplace Nagios)
	- Création de **Centreon-Broker** (remplace NDOUtils)
- 🧭 2018 : nouvelle logique de versioning → _année.mois_ (ex : 18.10)

## 🧱 Architecture et Installation

Centreon est composé de plusieurs briques :

|Composant|Rôle|
|---|---|
|**Centreon Web**|Interface graphique (Web) pour configurer et surveiller|
|**Centreon Engine**|Le moteur qui exécute les vérifications|
|**Centreon Broker**|Gère les flux de données entre Engine, DB et Web|
|**Base de données**|Stocke les résultats, historiques, config, logs|
|**Plugins / sondes**|Les scripts qui font les vérifications (check_ping, etc.)|

💡 Centreon **n’intègre aucun mécanisme de supervision en interne**. Les vérifications s’effectuent exclusivement via les **plugins**, qui sont des scripts exécutés par l’engine.

### 💽 Méthodes d’installation

Tu peux installer Centreon de plusieurs manières :
- 📀 Via **l’ISO officielle** (simple et rapide)
- 📦 Via **paquets RPM** (CentOS, Rocky Linux, Oracle Linux)
- 🖥️ Via **machine virtuelle**
- ⚙️ Via **compilation des sources**

🔗 Ressources utiles :
- [📘 Documentation officielle](https://docs.centreon.com/current/fr/installation/introduction.html)

## 🛠️ Configuration de Centreons

### Bonnes pratiques
- Rendre les **commandes les plus génériques et structurées possibles** : utiliser des **paramètres variables** pour éviter les commandes figées : ``CHECK_SNMP_CPU``, ``CHECK_NRPE_DISK``..
- Toujours utiliser **des arguments variables** avec macros ($ARGn$, $_HOST…$)
- Tester chaque commande en **ligne de commande avec centreon-engine** avant de l’ajouter dans l’interface

### Macros dans Centreon
Les **macros** permettent de rendre les commandes dynamiques. Elles sont remplacées au moment de l’exécution réelle.  

**Types principaux** :

|Type|Exemple / Usage|
|---|---|
|**Standards**|`$HOSTADDRESS$` : adresse IP de l’hôte|
|**Ressources**|`$USER1$`, `$CENTREONPLUGINS$` : chemins vers les plugins|
|**À la demande**|`$HOSTSTATE:nomHôte$` : état dynamique d’un autre objet|
|**Arguments**|`$ARG1$`, `$ARG2$` : seuils, valeurs variables (max 32)|
|**Personnalisées**|`$_HOSTSNMPVERSION$`, `$_SERVICEWARNING$` : plus claires, sans limite fixée|

>💡 Les macros personnalisées sont **recommandées** : plus lisibles et adaptables.
> Les macros se retrouvent dans Configuration / Pollers / Resources 


### Écriture des commandes

- Toujours **tester les commandes en shell** avec l’utilisateur `centreon-engine` avant de les intégrer à l’interface.
- Menu : `Configuration → Commands → Checks`
- Exemple : `check_snmp_cpu_windows --warning=$ARG1$ --critical=$ARG2$`

#### Exemple SNMP CPU

```bash
/usr/lib/centreon/plugins/centreon_windows_snmp.pl
--plugin=os::windows::snmp::plugin
--mode=cpu
--hostname=$HOSTADDRESS$ # Macro standard
--snmp-community=$_HOSTSNMPCOMMUNITY$ # Macro personnalisée 
--snmp-version=$_HOSTSNMPVERSION$
--warning-average=$ARG1$ # Macro Argument
--critical-average=$ARG2$
```


### Checks (sondes) - Commandes

Menu : **Configuration > Commands > Checks**

Champs à renseigner :

- Nom (ex: `CHECK_SNMP_CPU`)
- Ligne de commande avec variables ($ARGn$, $_HOST…$)
- Type de commande : `Check` ou `Misc`
- Plugin utilisé : chemin via macro `$CENTREONPLUGINS$`, `$USER1$`

### 🧱 Les modèles
<!-- tabs:start -->
#### **Modèle de service**

Un **service** = un indicateur qu’on veut surveiller sur l’hôte (CPU, mémoire, HTTP…)

🔹 **Modèle de service** = modèle réutilisable qui définit :
- La commande de supervision (check)
- Les seuils warning/critical
- Les périodes
- Les macros utilisées

📦 Deux types :
- **STC_** : modèle de configuration (`STC_DEFAULT`) → Check Period, Retry…
- **STF_** : modèle fonctionnel (`STF_SNMP_CPU`) → contient la commande à exécuter
- **Commande de check** : lien vers la commande de supervision (ex : `check_snmp_cpu`)

#####  Gestion des statuts : SOFT vs HARD

Centreon distingue deux états lorsqu’un service rencontre un problème :
- **SOFT** : erreur détectée mais non confirmée
    - Le moteur retente la vérification (`Retry Interval`) selon `Max Check Attempts`
    - Aucun message de notification n’est envoyé à ce stade
        
- **HARD** : erreur confirmée
    - La notification est envoyée
    - Le service entre en alerte (WARNING, CRITICAL...)
        

🟢 Un état OK est **automatiquement confirmé**.

> Exemple :
> - Normal Check Interval = 5 min
> - Max Check Attempts = 3
> - Retry Check Interval = 1 min  
>     Résultat : après 3 échecs à 1 min d’intervalle → le statut passe en HARD

##### Règles de nommage (recommandées)

Adopter une convention de nommage stricte :
- `STC_` pour _Service Template Configuration_
- `STF_` pour _Service Template Functional_
- `CHECK_` dans le nom de la commande liée

Cela facilite l’organisation, la recherche et la maintenance.

**Création**
Configuration / Service / Service Template dans Centreon
#### **Modèles d'hôte**

Un **hôte** = une machine à superviser (par son IP ou nom DNS)

🔹 **Modèle d’hôte (HTC/HTF)** = fiche de paramètres par défaut pour tous les hôtes de ce type  
Il peut contenir :
- La commande de vérification (ping…)
- Les paramètres SNMP
- Les intervalles
- Des modèles de services à déployer automatiquement

📦 Deux types :
- **HTC_** : configuration générique (`HTC_DEFAULT`)
- **HTF_** : selon rôle/fonction/OS (`HTF_LINUX_SRVWEB`, `HTF_WIN_DC`, etc.)

#### **Articulation**

```markdown
             Centreon Engine
                  ↓
             [HÔTE : serveur X]
                  ↑
       ┌──────────────────────────┐
       │   Modèle d’hôte HTF_WIN  │
       └──────────────────────────┘
                  ↓
   Applique les modèles de services :
     → STF_CPU_WIN
     → STF_RAM_WIN
     → STF_DISK_WIN

Chaque modèle de service :
- contient la commande CHECK_SNMP_CPU
- contient des macros ($_HOSTSNMPVERSION$, $_SERVICEWARNING$)

```

> 🔁 Tu crées donc un **modèle d’hôte**, tu y lies des **modèles de services**, et tu n’as plus qu’à **déployer un nouvel hôte** → tout s’applique automatiquement.

<!-- tabs:end -->
### 🔁 Application de la configuration

⚠️ Les modifications dans l’interface ne sont **pas appliquées directement**.

Étapes :
1. Génération des fichiers de config (`/usr/share/centreon/filesGeneration`) - Configuration / pollers / Export configuration
2. Vérification (mode debug recommandé)
3. Remplacement des anciens fichiers (`/etc/centreon/*.cfg`)
4. **Reload** du moteur Centreon

Ce mécanisme permet d’éviter de recharger une configuration invalide.

### 👁️ Interface de supervision

- Menu de supervision :
    - `Monitoring → Status Details → Services`
    - `Monitoring → Status Details → Hosts`

- Affichage par hôte ou service avec actions groupées disponibles
- Possibilité de consulter les **détails**, logs et raccourcis vers la config

## [Synthèse](/Supervision_Exploitation/Synthese_centreon.md)



